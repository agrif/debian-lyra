#!/bin/bash
set -e

USB_UDC=$(ls /sys/class/udc/ | head -n 1)
STRINGS_EN=strings/0x409
CONFIG=configs/c.1
GADGET_NAME=lyra

# use stable mac addresses for both ends, derived from systemd machine-id
# use two app keys to derive two different addresses
APP_KEY_DEV=7798d53ea71b4f298dd35be1ad45f64e
APP_KEY_HOST=3de145d241004365a26a18cb1b152081

# massage a systemd-id128 into a mac address
# locally-administered addresses set bit 1 of octet 0
# (we just use a fixed 42 for this octet)
generate_mac() {
    systemd-id128 machine-id --app-specific="$1" \
        | cut -c-10 \
        | sed -e 's/\(..\)/:\1/g' \
        | sed -e 's/.*/42&/'
}

uninstall() {
    disable

    cd /sys/kernel/config/usb_gadget/$GADGET_NAME
    if [ -d os_desc ]; then
        find os_desc -mindepth 1 -maxdepth 1 -type l -delete
    fi
    if [ -d configs ]; then
        find configs -mindepth 2 -maxdepth 2 -type l -delete
        find configs -mindepth 3 -maxdepth 3 -wholename "*/strings/*" -type d -delete
        find configs -mindepth 1 -maxdepth 1 -type d -delete
    fi
    if [ -d functions ]; then
        find functions -mindepth 1 -maxdepth 1 -type d -delete
    fi
    if [ -d strings ]; then
        find strings -mindepth 1 -maxdepth 1 -type d -delete
    fi

    cd ..
    rmdir $GADGET_NAME
}

install() {
    modprobe libcomposite
    cd /sys/kernel/config/
    mkdir -p usb_gadget/$GADGET_NAME
    cd usb_gadget/$GADGET_NAME

    echo "0x1d6b" > idVendor  # Linux Foundation
    echo "0x0104" > idProduct # Multifunction Composite Gadget

    mkdir -p ./$STRINGS_EN
    echo "0123456789ABCDEF" > ./$STRINGS_EN/serialnumber
    echo "Luckfox" > ./$STRINGS_EN/manufacturer
    cat /proc/device-tree/model > ./$STRINGS_EN/product

    mkdir -p ./$CONFIG
    echo "500" > ./$CONFIG/MaxPower

    echo "1" > os_desc/use
    echo "0x1" > os_desc/b_vendor_code
    echo "MSFT100" > os_desc/qw_sign
    ln -s $CONFIG/ os_desc/

    mkdir -p ./$CONFIG/$STRINGS_EN
    echo "lyra config name" > ./$CONFIG/$STRINGS_EN/configuration

    # turning this on breaks the network device (??)
    #mkdir -p functions/acm.lyra
    # on newer kernels, do this to prevent ModemManager from probing us
    #echo "0" > functions/acm.lyra/protocol
    #ln -s functions/acm.lyra ./$CONFIG/

    mkdir -p functions/rndis.lyra
    generate_mac $APP_KEY_DEV > functions/rndis.lyra/dev_addr
    generate_mac $APP_KEY_HOST > functions/rndis.lyra/host_addr
    echo "RNDIS" > functions/rndis.lyra/os_desc/interface.rndis/compatible_id
    echo "5162001" > functions/rndis.lyra/os_desc/interface.rndis/sub_compatible_id
    ln -s functions/rndis.lyra ./$CONFIG/
}

disable() {
    cd /sys/kernel/config/usb_gadget/$GADGET_NAME
    echo -n "" > UDC
}

enable() {
    install

    cd /sys/kernel/config/usb_gadget/$GADGET_NAME
    echo "$USB_UDC" > UDC
}

case "$1" in
    uninstall)
        shift
        uninstall "$@"
        ;;
    install)
        shift
        install "$@"
        ;;
    disable)
        shift
        disable "$@"
        ;;
    enable)
        shift
        enable "$@"
        ;;
    "")
        echo "usage: $0 <uninstall|install|disable|enable>" 1>&2
        exit 1
        ;;
    *)
        echo "unknown command: $1" 1>&2
        exit 1
        ;;
esac
