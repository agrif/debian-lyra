{{- $codename := or .codename "trixie" -}}
{{- $mirror := or .mirror "https://deb.debian.org/debian" -}}
{{- $hostname := or .hostname "luckfox" -}}
{{- $image := or .image (printf "debian-%s-luckfox-lyra-sd.img" $codename) -}}
{{- $username := or .username "lyra" -}}
{{- $password := or .password "luckfox" -}}

architecture: armhf

actions:
  - action: image-partition
    description: partition image
    imagename: {{ $image }}
    imagesize: 1536MiB
    partitiontype: gpt
    mountpoints:
      # - mountpoint: /boot
      #   partition: boot

      - mountpoint: /
        partition: root
        options: [ x-systemd.growfs ]

    partitions:
      # FIXME allow extlinux boot, allow root on other than partition 3
      - name: u-boot
        parttype: 3DE21764-95BD-54BD-A5C3-4ABE786F38A8
        fs: none
        start: 16384s # fixed address
        end: 24575s # +4MiB

      - name: boot
        fslabel: {{ $hostname }}boot
        parttype: BC13C2FF-59E6-4262-A352-B275FD6F7172
        #fs: vfat
        fs: none
        start: 24576s
        end: 548863s # +256MiB
        flags: [ legacy_boot ]

      - name: root
        fslabel: {{ $hostname }} root
        parttype: 69DAD710-2CE4-4E3C-B16C-21A1D49ABED3
        fs: ext4
        start: 548864s
        end: 100%

      # morally this goes first, but right now partition order matters
      - name: idblock
        parttype: 3DE21764-95BD-54BD-A5C3-4ABE786F38A8
        fs: none
        start: 64s # fixed address
        end: 1087s # +512kiB

  - action: raw
    description: write idblock
    origin: artifacts
    source: parts/idblock.img
    partition: idblock

  - action: raw
    description: write u-boot
    origin: artifacts
    source: parts/u-boot.itb
    partition: u-boot

  - action: raw
    description: write kernel
    origin: recipe
    source: blobs/kernel.img
    partition: boot

  # FIXME kernel packages
  # - action: overlay
  #   description: install /boot
  #   source: boot/
  #   destination: /boot/

  # - action: overlay
  #   description: install kernel
  #   source: blobs/zImage
  #   destination: /boot/zImage

  # - action: overlay
  #   description: install device tree
  #   source: blobs/device-tree.dtb
  #   destination: /boot/device-tree.dtb

  - action: debootstrap
    description: bootstrap debian {{ $codename }}
    suite: {{ $codename }}
    components:
      - main
      - contrib
      - non-free
      - non-free-firmware
    mirror: {{ $mirror }}

  - action: run
    description: set {{ $codename }} apt repositories
    chroot: true
    command: |
      echo "# {{ $codename }} main repo" > /etc/apt/sources.list
      echo "deb https://deb.debian.org/debian/ {{ $codename }} main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "deb-src https://deb.debian.org/debian/ {{ $codename }} main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "" >> /etc/apt/sources.list
      echo "# {{ $codename }} security repo" >> /etc/apt/sources.list
      echo "deb https://security.debian.org/debian-security {{ $codename }}-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "deb-src https://security.debian.org/debian-security {{ $codename }}-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "" >> /etc/apt/sources.list
      echo "# {{ $codename }} updates repo" >> /etc/apt/sources.list
      echo "deb https://deb.debian.org/debian/ {{ $codename }}-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "deb-src https://deb.debian.org/debian/ {{ $codename }}-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list

  - action: apt
    description: update apt sources
    update: true

  - action: run
    description: set hostname
    chroot: true
    command: |
      echo "{{ $hostname }}" > /etc/hostname
      echo "127.0.0.1	localhost" > /etc/hosts
      echo "127.0.1.1	{{ $hostname }}" >> /etc/hosts
      echo "" >> /etc/hosts
      echo "# The following lines are desirable for IPv6 capable hosts" >> /etc/hosts
      echo "::1     localhost ip6-localhost ip6-loopback" >> /etc/hosts
      echo "ff02::1 ip6-allnodes" >> /etc/hosts
      echo "ff02::2 ip6-allrouters" >> /etc/hosts

  - action: run
    description: set up user
    chroot: true
    script: scripts/setup-user.sh {{ $username }} {{ $password }}

  - action: apt
    description: install tasksel
    packages:
      - tasksel

  - action: run
    description: install standard packages
    chroot: true
    command: DEBIAN_FRONTEND=noninteractive tasksel install standard ssh-server

  - action: apt
    description: install extra packages
    recommends: true
    packages:
      - fake-hwclock
      - sudo
      - systemd-repart

  - action: run
    description: set locale
    chroot: true
    command: update-locale LANG=C.UTF-8

  - action: overlay
    description: install custom configuration
    source: overlays/etc/
    destination: /etc/

  - action: run
    description: enable custom systemd units
    chroot: true
    command: |
      mkdir -p /etc/systemd/system/multi-user.target.wants
      ln -s /etc/systemd/system/regen-openssh-keys.service /etc/systemd/system/multi-user.target.wants/regen-openssh-keys.service

  - action: run
    description: clean up root
    chroot: true
    script: scripts/rootfs-cleanup.sh

  - action: filesystem-deploy
    description: deploy filesystem image

  - action: run
    description: create bmap file
    postprocess: true
    command: bmaptool create ${ARTIFACTDIR}/{{ $image }} -o ${ARTIFACTDIR}/{{ $image }}.bmap

  - action: run
    description: compress image file
    postprocess: true
    command: xz -f ${ARTIFACTDIR}/{{ $image }}
