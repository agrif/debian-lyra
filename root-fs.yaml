{{- $codename := or .codename "trixie" -}}
{{- $hostname := or .hostname "luckfox" -}}
{{- $username := or .username "lyra" -}}
{{- $password := or .password "luckfox" -}}
{{- $mirror := or .mirror "https://deb.debian.org/debian" -}}

architecture: armhf

actions:
  - action: debootstrap
    description: bootstrap debian {{ $codename }}
    suite: {{ $codename }}
    components:
      - main
      - contrib
      - non-free
      - non-free-firmware
    mirror: {{ $mirror }}

  - action: run
    description: set {{ $codename }} apt repositories
    chroot: true
    command: |
      echo "# {{ $codename }} main repo" > /etc/apt/sources.list
      echo "deb https://deb.debian.org/debian/ {{ $codename }} main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "deb-src https://deb.debian.org/debian/ {{ $codename }} main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "" >> /etc/apt/sources.list
      echo "# {{ $codename }} security repo" >> /etc/apt/sources.list
      echo "deb https://security.debian.org/debian-security {{ $codename }}-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "deb-src https://security.debian.org/debian-security {{ $codename }}-security main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "" >> /etc/apt/sources.list
      echo "# {{ $codename }} updates repo" >> /etc/apt/sources.list
      echo "deb https://deb.debian.org/debian/ {{ $codename }}-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list
      echo "deb-src https://deb.debian.org/debian/ {{ $codename }}-updates main contrib non-free non-free-firmware" >> /etc/apt/sources.list

  - action: apt
    description: update apt sources
    update: true

  - action: run
    description: set hostname
    chroot: true
    command: |
      echo "{{ $hostname }}" > /etc/hostname
      echo "127.0.0.1	localhost" > /etc/hosts
      echo "127.0.1.1	{{ $hostname }}" >> /etc/hosts
      echo "" >> /etc/hosts
      echo "# The following lines are desirable for IPv6 capable hosts" >> /etc/hosts
      echo "::1     localhost ip6-localhost ip6-loopback" >> /etc/hosts
      echo "ff02::1 ip6-allnodes" >> /etc/hosts
      echo "ff02::2 ip6-allrouters" >> /etc/hosts

  - action: run
    description: add user
    chroot: true
    script: scripts/add-user.sh {{ $username }} {{ $password }}

  - action: apt
    description: install tasksel
    packages:
      - tasksel

  - action: run
    description: install standard packages
    chroot: true
    command: DEBIAN_FRONTEND=noninteractive tasksel install standard ssh-server

  - action: apt
    description: install extra packages
    recommends: true
    packages:
      - fake-hwclock
      - lrzsz
      - sudo
      - systemd-repart
      - u-boot-menu

  - action: run
    description: set locale
    chroot: true
    command: update-locale LANG=C.UTF-8

  - action: overlay
    description: install custom configuration
    source: overlays/etc/
    destination: /etc/

  - action: run
    description: enable custom systemd units
    chroot: true
    command: |
      mkdir -p /etc/systemd/system/multi-user.target.wants
      ln -s /etc/systemd/system/regen-openssh-keys.service /etc/systemd/system/multi-user.target.wants/regen-openssh-keys.service

  - action: run
    description: clean up root
    chroot: true
    script: scripts/rootfs-cleanup.sh

  - action: pack
    description: create root tarball
    file: parts/root.tar.xz
    compression: xz
