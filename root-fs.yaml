{{- $codename := or .codename "trixie" -}}
{{- $hostname := or .hostname "luckfox" -}}
{{- $username := or .username "lyra" -}}
{{- $password := or .password "luckfox" -}}
{{- $mirror := or .mirror "https://deb.debian.org/debian" -}}

architecture: armhf

actions:
  - action: debootstrap
    description: bootstrap debian {{ $codename }}
    suite: {{ $codename }}
    components:
      - main
      - contrib
      - non-free
      - non-free-firmware
    mirror: {{ $mirror }}

  - action: run
    description: add {{ $codename }} apt repositories
    chroot: true
    script: scripts/add-main-repos.sh {{ $codename }}

  - action: apt
    description: update apt sources
    update: true

  - action: run
    description: set hostname
    chroot: true
    script: scripts/set-hostname.sh {{ $hostname }}

  - action: run
    description: add user
    chroot: true
    script: scripts/add-user.sh {{ $username }} {{ $password }}

  - action: apt
    description: install tasksel
    packages:
      - tasksel

  - action: run
    description: install standard packages
    chroot: true
    command: DEBIAN_FRONTEND=noninteractive tasksel install standard ssh-server

  - action: apt
    description: install extra packages
    recommends: true
    packages:
      - dphys-swapfile
      - fake-hwclock
      - initramfs-tools
      - lrzsz
      - sudo
      - systemd-repart
      - u-boot-menu

  - action: run
    description: set locale
    chroot: true
    command: update-locale LANG=C.UTF-8

  - action: overlay
    description: install custom configuration
    source: overlays/etc/
    destination: /etc/

  - action: run
    description: enable custom systemd units
    chroot: true
    command: |
      mkdir -p /etc/systemd/system/multi-user.target.wants
      ln -s /etc/systemd/system/regen-openssh-keys.service /etc/systemd/system/multi-user.target.wants/regen-openssh-keys.service

  - action: run
    description: clean up root
    chroot: true
    script: scripts/rootfs-cleanup.sh

  - action: pack
    description: create root tarball
    file: parts/root.tar.xz
    compression: xz
