{{- $codename := or .codename "trixie" -}}
{{- $image := or .image (printf "luckfox-lyra-%s-sd.img" $codename) -}}

architecture: armhf
sectorsize: 512

actions:
  - action: image-partition
    description: partition image
    imagename: {{ $image }}
    imagesize: 1536MiB
    partitiontype: gpt
    mountpoints:
      - mountpoint: /boot
        partition: boot

      - mountpoint: /
        partition: root
        options: [ x-systemd.growfs ]

    partitions:
      # FIXME allow root on other than partition 3
      - name: u-boot
        parttype: 3DE21764-95BD-54BD-A5C3-4ABE786F38A8
        fs: none
        start: 16384s # fixed address
        end: 24575s # +4MiB

      - name: boot
        fslabel: lyra boot
        parttype: BC13C2FF-59E6-4262-A352-B275FD6F7172
        fs: vfat
        start: 24576s
        end: 548863s # +256MiB
        flags: [ legacy_boot ]

      - name: root
        fslabel: lyra root
        parttype: 69DAD710-2CE4-4E3C-B16C-21A1D49ABED3
        fs: ext4
        start: 548864s
        end: 100%

      # morally this goes first, but right now partition order matters
      - name: idblock
        parttype: 3DE21764-95BD-54BD-A5C3-4ABE786F38A8
        fs: none
        start: 64s # fixed address
        end: 1087s # +512kiB

  - action: raw
    description: write idblock
    origin: artifacts
    source: parts/idblock.img
    partition: idblock

  - action: raw
    description: write u-boot
    origin: artifacts
    source: parts/u-boot.itb
    partition: u-boot

  # FIXME kernel packages
  - action: overlay
    description: install /boot
    source: overlays/boot/
    destination: /boot/

  - action: overlay
    description: install device tree
    origin: artifacts
    source: parts/device-tree.dtb
    destination: /boot/device-tree.dtb

  - action: unpack
    description: unpack root tarball
    file: parts/root.tar.xz
    compression: xz

  - action: overlay
    description: add local packages
    origin: artifacts
    source: packages/
    destination: /opt/lyra-packages

  - action: run
    description: generate and install repository for local packages
    chroot: true
    command: |
      cd /opt/lyra-packages
      apt-ftparchive packages . > Packages
      apt-ftparchive contents . > Contents
      apt-ftparchive release . > Release
      echo "deb [trusted=yes] file:/opt/lyra-packages/ ./" > /etc/apt/sources.list.d/lyra-packages.list
      echo "deb-src [trusted=yes] file:/opt/lyra-packages/ ./" >> /etc/apt/sources.list.d/lyra-packages.list

  - action: apt
    description: install local packages
    update: true
    recommends: true
    packages:
      - linux-image-6.6.89+

  - action: filesystem-deploy
    description: deploy filesystem image

  - action: run
    description: create bmap file
    postprocess: true
    command: bmaptool create ${ARTIFACTDIR}/{{ $image }} -o ${ARTIFACTDIR}/{{ $image }}.bmap

  - action: run
    description: compress image file
    postprocess: true
    command: xz -f ${ARTIFACTDIR}/{{ $image }}
