{{- $codename := or .codename "trixie" -}}
{{- $devicetree := or .devicetree "rk3506g-luckfox-lyra.dtb" -}}
{{- $image := or .image (printf "luckfox-lyra-%s-sd.img" $codename) -}}

architecture: armhf
sectorsize: 512

actions:
  - action: image-partition
    description: partition image
    imagename: {{ $image }}
    imagesize: 1536MiB
    partitiontype: gpt
    mountpoints:
      - mountpoint: /boot
        partition: boot

      - mountpoint: /
        partition: root
        options: [ x-systemd.growfs ]

    partitions:
      - name: u-boot
        parttype: 3DE21764-95BD-54BD-A5C3-4ABE786F38A8
        fs: none
        start: 64s # fixed address
        end: 32767s # + 16MiB (give or take, -32kiB)

      - name: boot
        fslabel: lyra boot
        parttype: BC13C2FF-59E6-4262-A352-B275FD6F7172
        fs: ext4
        start: 32768s
        end: 557055s # +256MiB
        flags: [ legacy_boot ]

      - name: root
        fslabel: lyra root
        parttype: 69DAD710-2CE4-4E3C-B16C-21A1D49ABED3
        fs: ext4
        start: 557056s
        end: 100%

  - action: raw
    description: write u-boot
    origin: artifacts
    source: parts/u-boot-rockchip.bin
    partition: u-boot

  - action: unpack
    description: unpack root tarball
    file: parts/root.tar.xz
    compression: xz

  - action: overlay
    description: add local packages
    origin: artifacts
    source: packages/
    destination: /opt/lyra-packages

  - action: run
    description: generate and install repository for local packages
    chroot: true
    script: scripts/add-local-repo.sh

  - action: run
    description: configure u-boot-menu
    chroot: true
    script: scripts/configure-boot-menu.sh {{ $devicetree }}

  - action: filesystem-deploy
    description: deploy filesystem image
    setup-kernel-cmdline: false

  # note: must run *after* filesystem deploy, so that u-boot-update works right
  - action: apt
    description: install local packages
    update: true
    recommends: true
    packages:
      - linux-image-6.6.89+
      - lyra-usb-gadget

  # note: must run *after* filesystem deploy, to modify /etc/fstab
  - action: run
    description: fix /run size
    chroot: true
    script: scripts/fix-run-size.sh

  - action: run
    description: create bmap file
    postprocess: true
    command: bmaptool create ${ARTIFACTDIR}/{{ $image }} -o ${ARTIFACTDIR}/{{ $image }}.bmap

  - action: run
    description: compress image file
    postprocess: true
    command: xz -f ${ARTIFACTDIR}/{{ $image }}
